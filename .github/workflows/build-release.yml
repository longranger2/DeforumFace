name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# æ·»åŠ æƒé™è®¾ç½®
permissions:
  contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹ï¼ˆåˆ›å»ºreleaseéœ€è¦ï¼‰
  actions: read    # å…è®¸è¯»å–actions
  packages: write  # å…è®¸å†™å…¥packagesï¼ˆå¦‚æžœéœ€è¦ï¼‰

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
        include:
          - os: windows-latest
            executable_name: HeadAlignmentTool.exe
            artifact_name: HeadAlignmentTool-Windows
          - os: macos-latest
            executable_name: HeadAlignmentTool
            artifact_name: HeadAlignmentTool-macOS
          - os: ubuntu-latest
            executable_name: HeadAlignmentTool
            artifact_name: HeadAlignmentTool-Linux

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1 libgstreamer1.0-0 libgstreamer-plugins-base1.0-0

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Debug environment (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        echo "=== Python Environment ==="
        python --version
        pip list | findstr -i "mediapipe streamlit opencv"
        echo "=== Site Packages ==="
        python -c "import site; print('Site packages:', site.getsitepackages())"
        echo "=== MediaPipe Check ==="
        python -c "import mediapipe as mp; import os; print('MediaPipe path:', os.path.dirname(mp.__file__))"
        echo "=== OpenCV Check ==="
        python -c "import cv2; print('OpenCV version:', cv2.__version__)"

    - name: Debug environment (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        echo "=== Python Environment ==="
        python --version
        pip list | grep -i -E "(mediapipe|streamlit|opencv)"
        echo "=== Site Packages ==="
        python -c "import site; print('Site packages:', site.getsitepackages())"
        echo "=== MediaPipe Check ==="
        python -c "import mediapipe as mp; import os; print('MediaPipe path:', os.path.dirname(mp.__file__))"
        echo "=== OpenCV Check ==="
        python -c "import cv2; print('OpenCV version:', cv2.__version__)"

    - name: Prepare build environment
      run: python prepare_build.py

    - name: Debug spec file
      run: |
        echo "=== Generated Spec File ==="
        cat HeadAlignmentTool.spec

    - name: Build executable
      run: pyinstaller HeadAlignmentTool.spec --clean --noconfirm

    - name: Check build result
      run: python -c "import os; print('Build completed!'); [print(f'  - {item}') for item in os.listdir('dist')] if os.path.exists('dist') else print('âŒ dist directory not found')"

    - name: Test executable (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        echo "=== Testing Windows executable ==="
        cd dist
        dir
        echo "=== Checking executable dependencies ==="
        # ç®€å•æµ‹è¯•ï¼šæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å¯æ‰§è¡Œ
        if (Test-Path "HeadAlignmentTool.exe") {
          echo "âœ… Executable exists"
          # èŽ·å–æ–‡ä»¶å¤§å°
          $size = (Get-Item "HeadAlignmentTool.exe").Length / 1MB
          echo "ðŸ“¦ Size: $([math]::Round($size, 2)) MB"
        } else {
          echo "âŒ Executable not found"
          exit 1
        }

    - name: Test executable (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        echo "=== Testing Unix executable ==="
        cd dist
        ls -la
        if [ -f "HeadAlignmentTool" ]; then
          echo "âœ… Executable exists"
          size=$(du -m HeadAlignmentTool | cut -f1)
          echo "ðŸ“¦ Size: ${size} MB"
          chmod +x HeadAlignmentTool
        else
          echo "âŒ Executable not found"
          exit 1
        fi

    - name: Create distribution directory
      run: mkdir -p distribution

    - name: Copy executable and create package (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        copy dist\HeadAlignmentTool.exe distribution\
        echo "# Head Alignment Tool - Windows" > distribution\README.txt
        echo "" >> distribution\README.txt
        echo "è¿è¡Œæ–¹å¼ï¼š" >> distribution\README.txt
        echo "1. åŒå‡» HeadAlignmentTool.exe å¯åŠ¨åº”ç”¨" >> distribution\README.txt
        echo "2. ç­‰å¾…åº”ç”¨å¯åŠ¨ï¼ˆå¯èƒ½éœ€è¦å‡ ç§’é’Ÿï¼‰" >> distribution\README.txt
        echo "3. æµè§ˆå™¨ä¼šè‡ªåŠ¨æ‰“å¼€ http://localhost:8501" >> distribution\README.txt
        echo "4. å¦‚æžœæµè§ˆå™¨æ²¡æœ‰è‡ªåŠ¨æ‰“å¼€ï¼Œè¯·æ‰‹åŠ¨è®¿é—®ä¸Šè¿°åœ°å€" >> distribution\README.txt
        echo "" >> distribution\README.txt
        echo "æ³¨æ„ï¼šé¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚" >> distribution\README.txt
        echo "å¦‚æžœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥Windows Defenderæ˜¯å¦é˜»æ­¢äº†ç¨‹åºè¿è¡Œã€‚" >> distribution\README.txt

    - name: Copy executable and create package (macOS/Linux)
      if: matrix.os != 'windows-latest'
      run: |
        cp dist/HeadAlignmentTool distribution/
        chmod +x distribution/HeadAlignmentTool
        cat > distribution/README.txt << 'EOF'
        # Head Alignment Tool - Unix

        è¿è¡Œæ–¹å¼ï¼š
        1. æ‰“å¼€ç»ˆç«¯
        2. è¿›å…¥æ­¤ç›®å½•
        3. è¿è¡Œï¼š./HeadAlignmentTool
        4. ç­‰å¾…åº”ç”¨å¯åŠ¨ï¼ˆå¯èƒ½éœ€è¦å‡ ç§’é’Ÿï¼‰
        5. æµè§ˆå™¨ä¼šè‡ªåŠ¨æ‰“å¼€ http://localhost:8501
        6. å¦‚æžœæµè§ˆå™¨æ²¡æœ‰è‡ªåŠ¨æ‰“å¼€ï¼Œè¯·æ‰‹åŠ¨è®¿é—®ä¸Šè¿°åœ°å€

        æ³¨æ„ï¼šé¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚
        EOF

    - name: Create archive (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        cd distribution
        7z a -tzip ../HeadAlignmentTool-Windows.zip *

    - name: Create archive (macOS/Linux)
      if: matrix.os != 'windows-latest'
      run: |
        cd distribution
        tar -czf ../HeadAlignmentTool-${{ matrix.artifact_name }}.tar.gz *

    - name: Upload artifact (Windows)
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: HeadAlignmentTool-Windows.zip

    - name: Upload artifact (macOS/Linux)
      if: matrix.os != 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: HeadAlignmentTool-${{ matrix.artifact_name }}.tar.gz

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: List downloaded files (debug)
      run: |
        echo "=== Current directory structure ==="
        ls -la
        find . -name "*.zip" -o -name "*.tar.gz" | head -10

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: Head Alignment Tool ${{ github.ref_name }}
        body: |
          ## Head Alignment Tool ${{ github.ref_name }}

          ### ä¸‹è½½è¯´æ˜Ž
          - **Windowsç”¨æˆ·**: ä¸‹è½½ `HeadAlignmentTool-Windows.zip`ï¼Œè§£åŽ‹åŽåŒå‡» `HeadAlignmentTool.exe` è¿è¡Œ
          - **macOSç”¨æˆ·**: ä¸‹è½½ `HeadAlignmentTool-macOS.tar.gz`ï¼Œè§£åŽ‹åŽåœ¨ç»ˆç«¯è¿è¡Œ `./HeadAlignmentTool`
          - **Linuxç”¨æˆ·**: ä¸‹è½½ `HeadAlignmentTool-Linux.tar.gz`ï¼Œè§£åŽ‹åŽåœ¨ç»ˆç«¯è¿è¡Œ `./HeadAlignmentTool`

          ### ä½¿ç”¨æ–¹æ³•
          1. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶
          2. ç­‰å¾…åº”ç”¨å¯åŠ¨ï¼ˆé¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼‰
          3. æµè§ˆå™¨ä¼šè‡ªåŠ¨æ‰“å¼€åº”ç”¨ç•Œé¢
          4. ä¸Šä¼ éœ€è¦å¯¹é½çš„å¤´éƒ¨å›¾ç‰‡
          5. è°ƒæ•´å‚æ•°å¹¶ä¸‹è½½å¤„ç†ç»“æžœ

          ### ç³»ç»Ÿè¦æ±‚
          - Windows 10/11 (64ä½)
          - macOS 10.14+ (Intel/Apple Silicon)
          - Linux (64ä½ï¼Œéœ€è¦GUIæ”¯æŒ)

          ### æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡è¿è¡Œæ—¶å¯èƒ½éœ€è¦è¾ƒé•¿çš„å¯åŠ¨æ—¶é—´
          - ç¡®ä¿ç³»ç»Ÿæœ‰è¶³å¤Ÿçš„å†…å­˜ï¼ˆå»ºè®®4GB+ï¼‰
          - Windowsç”¨æˆ·ï¼šå¦‚æžœWindows Defenderé˜»æ­¢ç¨‹åºè¿è¡Œï¼Œè¯·æ·»åŠ ä¿¡ä»»
          - å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹é¡¹ç›®READMEæˆ–æäº¤Issue

          ### å·²çŸ¥é—®é¢˜ä¿®å¤
          - ä¿®å¤äº†Windowsç‰ˆæœ¬çš„MediaPipeä¾èµ–é—®é¢˜
          - æ”¹è¿›äº†è·¨å¹³å°è·¯å¾„å¤„ç†
          - å¢žå¼ºäº†é”™è¯¯è¯Šæ–­å’Œè°ƒè¯•ä¿¡æ¯
        draft: false
        prerelease: false
        files: |
          HeadAlignmentTool-Windows/*.zip
          HeadAlignmentTool-macOS/*.tar.gz
          HeadAlignmentTool-Linux/*.tar.gz 